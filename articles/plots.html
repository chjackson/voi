<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="voi">
<title>Plots of Value of Information measures • voi</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Plots of Value of Information measures">
<meta property="og:description" content="voi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">voi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/voi.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/book.html">Value of Information for Health Economic Evaluations: book code resources</a>
    <a class="dropdown-item" href="../articles/plots.html">Plots of Value of Information measures</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/voi/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Plots of Value of Information measures</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson</h4>
            
            <h4 data-toc-skip class="date">2023-08-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/voi/blob/HEAD/vignettes/plots.Rmd" class="external-link"><code>vignettes/plots.Rmd</code></a></small>
      <div class="d-none name"><code>plots.Rmd</code></div>
    </div>

    
    
<p>The <code>voi</code> package functions <code><a href="../reference/evppi.html">evppi()</a></code>,
<code><a href="../reference/evpi.html">evpi()</a></code> and <code><a href="../reference/evsi.html">evsi()</a></code> all return data frames in a
“tidy” format with one row per VoI estimate. This allows plots to be
produced and customised with little further effort using
<code>ggplot2</code>.</p>
<p>This vignette demonstrates how to illustrate VoI analyses
graphically, using an example EVSI results dataset
<code>chemo_evsi_or</code> supplied with the <code>voi</code>
package.</p>
<p>We also explain the use of the <code><a href="../reference/enbs.html">enbs()</a></code> function to
calculate and optimise the expected net benefit of sampling for a simple
study design.</p>
<p>Knowledge of <a href="https://ggplot2.tidyverse.org/" class="external-link">ggplot2</a> is
required to be able to adapt these plots for your own analyses and
communication needs, but plenty of learning resources are linked from
the <a href="https://ggplot2.tidyverse.org/#learning-ggplot2" class="external-link">ggplot2
home page</a>.</p>
<p>Some functions to create similar plots using base R graphics are
supplied with the <a href="https://chjackson.github.io/voi/articles/book.html">VoI
Book</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://chjackson.github.io/voi/">voi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-evsi-dataset">Example EVSI dataset<a class="anchor" aria-label="anchor" href="#example-evsi-dataset"></a>
</h2>
<p>The example dataset <code>chemo_evsi_or</code> included with the
package gives the results of an EVSI analysis for the chemotherapy
example model.</p>
<p>This object is a data frame with 15030 rows and three columns, giving
the sample size per arm (<code>n</code>, from 50 to 1500),
willingness-to-pay (<code>k</code>, from 10000 to 50000 pounds) and the
corresponding EVSI (<code>evsi</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">chemo_evsi_or</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    n   k evsi</span></span>
<span><span class="co">## 1 50   0    0</span></span>
<span><span class="co">## 2 50 100    0</span></span>
<span><span class="co">## 3 50 200    0</span></span>
<span><span class="co">## 4 50 300    0</span></span>
<span><span class="co">## 5 50 400    0</span></span>
<span><span class="co">## 6 50 500    0</span></span></code></pre>
<blockquote>
<p><strong>Sidenote:</strong> The EVSI in this example is the expected
value of a two-arm trial with a binary outcome of whether a patient
experiences side-effects. The trial is only used to inform the log odds
ratio of side effects between treatments, and information about the
baseline risk of side effects is ignored. Source code for generating
this dataset using the moment matching method in <code><a href="../reference/evsi.html">evsi()</a></code> is
provided <a href="https://github.com/chjackson/voi/blob/master/data-raw/chemo_evsi_or.R" class="external-link">here</a>.</p>
</blockquote>
<p>For reference, we also calculate the EVPI for the corresponding
willingness-to-pay values, using output from probabilistic analysis of
the decision model, as stored in the object <code>chemo_cea_501</code>
provided with the <code>voi</code> package.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evpi_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/evpi.html">evpi</a></span><span class="op">(</span>outputs <span class="op">=</span> <span class="va">chemo_cea_501</span><span class="op">)</span></span></code></pre></div>
<p>We also extract the values of the EVPPI (for the log odds ratio) into
a data frame of the same format. These EVPPI values are already stored
in <code>chemo_evsi_or</code>, because they had been calculated as a
by-product of the moment matching method to calculate EVSI.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evppi_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">chemo_evsi_or</span>, <span class="st">"evppi"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="evsi-curves">EVSI curves<a class="anchor" aria-label="anchor" href="#evsi-curves"></a>
</h2>
<p>The following <code>ggplot</code> code produces curves of EVSI
against willingness to pay, with different sample sizes shown by curves
of different colours. The sample size is indicated by a colour gradient.
The corresponding curves of EVPI, and EVPPI for the “focal” parameter of
interest (the log odds ratio of side effects), are also shown for
reference.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">chemo_evsi_or</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">k</span>, y<span class="op">=</span><span class="va">evsi</span>, group<span class="op">=</span><span class="va">n</span>, color<span class="op">=</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient</a></span><span class="op">(</span>low<span class="op">=</span><span class="st">"skyblue"</span>, high<span class="op">=</span><span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Willingness to pay (£)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"EVSI per person"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">evpi_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">k</span>, y<span class="op">=</span><span class="va">evpi</span><span class="op">)</span>, </span>
<span>            color<span class="op">=</span><span class="st">"black"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">evppi_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">k</span>, y<span class="op">=</span><span class="va">evppi</span><span class="op">)</span>, </span>
<span>            color<span class="op">=</span><span class="st">"darkblue"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"Sample size"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">52000</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="fl">50000</span>,y<span class="op">=</span><span class="fl">125</span>,label<span class="op">=</span><span class="st">"EVPI"</span>,hjust<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="fl">50000</span>,y<span class="op">=</span><span class="fl">107</span>,label<span class="op">=</span><span class="st">"EVPPI"</span>,color<span class="op">=</span><span class="st">"darkblue"</span>,hjust<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="fl">50000</span>,y<span class="op">=</span><span class="fl">50</span>,label<span class="op">=</span><span class="st">"EVSI"</span>,color<span class="op">=</span><span class="st">"darkblue"</span>,hjust<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Or we can adapt the plot to only show a limited number of sample
sizes, shown in a discrete legend, and customise the colour range.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">250</span>, <span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">chemo_evsi_or</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">n_use</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">k</span>, y<span class="op">=</span><span class="va">evsi</span>, group<span class="op">=</span><span class="va">n</span>, color<span class="op">=</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_colour_binned</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="va">n_use</span>, </span>
<span>                      low <span class="op">=</span> <span class="st">"gray80"</span>, high <span class="op">=</span> <span class="st">"gray20"</span>,</span>
<span>                      guide<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Sample size"</span>,</span>
<span>                                         reverse<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Willingness to pay (£)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"EVSI (per person)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">evppi_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">k</span>, y<span class="op">=</span><span class="va">evppi</span><span class="op">)</span>, </span>
<span>            color<span class="op">=</span><span class="st">"darkblue"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, lty<span class="op">=</span><span class="fl">3</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">50000</span>, y<span class="op">=</span><span class="fl">130</span>, col<span class="op">=</span><span class="st">"darkblue"</span>, label<span class="op">=</span><span class="st">"EVPPI"</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>In a similar way, we can produce curves of EVSI against sample size,
with different willingness-to-pay (WTP) values shown by curves of
different colours. To reduce visual clutter, only a limited number of
willingness-to-pay values are illustrated. This plot shows how the EVSI
converges to the (WTP-dependent) EVPPI for the focal parameter (log odds
ratio of side effects) as the sample size increases.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chemo_evsi_or</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10000</span>,<span class="fl">50000</span>, by<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n</span>, y<span class="op">=</span><span class="va">evsi</span>, group<span class="op">=</span><span class="va">k</span>, color<span class="op">=</span><span class="va">k</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient</a></span><span class="op">(</span>low<span class="op">=</span><span class="st">"skyblue"</span>, high<span class="op">=</span><span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Sample size"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"EVSI per person"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"Willingness-to-pay (£)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="expected-net-benefit-of-sampling">Expected net benefit of sampling<a class="anchor" aria-label="anchor" href="#expected-net-benefit-of-sampling"></a>
</h2>
<p>The <code>voi</code> package includes a function <code><a href="../reference/enbs.html">enbs()</a></code>
to obtain the expected net benefit of sampling for a proposed study of
individual participants, given estimates of EVSI. See the help page
<code><a href="../reference/enbs.html">enbs()</a></code> for full documentation for this function.</p>
<blockquote>
<p>The <code><a href="../reference/enbs.html">enbs()</a></code> function supposes that the costs of the study
include a fixed setup cost (<code>costs_setup</code>), and a cost per
participant recruited (<code>costs_pp</code>). (Note that if
<code>n</code> describes the sample size per arm in a two-arm study,
<code>costs_pp</code> is actually the cost of recruiting two people, one
in each arm.) To acknowledge uncertainty, a range of costs may be
supplied as two numbers. These are assumed to describe a 95% credible
interval for the cost, with the point estimate given by the midpoint
between these two numbers.</p>
</blockquote>
<blockquote>
<p>Additional required information includes the size of the population
affected by the decision (<code>pop</code>), and a discount rate
(<code>disc</code>, by default 0.035) to be applied over a time horizon
<code>time</code>. These may be supplied as vectors, in which case ENBS
is calculated for all potential combinations of values (<a href="#probce">see below</a> for an example).</p>
</blockquote>
<p>Here is an example of calling <code><a href="../reference/enbs.html">enbs()</a></code>. The result is a
data frame giving the sample size (<code>n</code>), willingness-to-pay
(<code>k</code>), and corresponding ENBS (<code>enbs</code>). The
standard deviation (<code>sd</code>) describes the uncertainty about the
ENBS estimate due to the uncertain costs. <code>pce</code> is the
probability that the study is cost-effective (i.e. has a positive net
benefit of sampling). The other components of this data frame are
related to the optimal sample size <a href="#optss">(as discussed
below)</a></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enbs.html">enbs</a></span><span class="op">(</span><span class="va">chemo_evsi_or</span>, </span>
<span>            costs_setup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5000000</span>, <span class="fl">10000000</span><span class="op">)</span>, </span>
<span>            costs_pp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28000</span>, <span class="fl">42000</span><span class="op">)</span>, </span>
<span>            pop <span class="op">=</span> <span class="fl">46000</span>, </span>
<span>            time <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">nbs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span><span class="op">==</span><span class="fl">20000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n     k     enbs      sd pce ind  enbsmax nmax nlower nupper</span></span>
<span><span class="co">## 1  50 20000 48163756 1262191   1 201 84091443  450    250    750</span></span>
<span><span class="co">## 2 100 20000 63770725 1298075   1 201 84091443  450    250    750</span></span>
<span><span class="co">## 3 150 20000 72116178 1355775   1 201 84091443  450    250    750</span></span>
<span><span class="co">## 4 200 20000 77115463 1432655   1 201 84091443  450    250    750</span></span>
<span><span class="co">## 5 250 20000 80233182 1525819   1 201 84091443  450    250    750</span></span>
<span><span class="co">## 6 300 20000 82172795 1632483   1 201 84091443  450    250    750</span></span></code></pre>
<p>The expected net benefit of sampling for a given willingness-to-pay
can then be illustrated by filtering the <code>nbs</code> dataframe to
this willingness-to-pay value, then passing it to a simple
<code>ggplot</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span><span class="op">==</span><span class="fl">20000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n</span>, y<span class="op">=</span><span class="va">enbs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Sample size"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected net benefit of sampling"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html" class="external-link">dollar_format</a></span><span class="op">(</span>prefix<span class="op">=</span><span class="st">"£"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<blockquote>
<p>Note the <code><a href="https://scales.r-lib.org/reference/dollar_format.html" class="external-link">scales::dollar_format</a></code> trick for showing large
currency values tidily in the axis labels.</p>
</blockquote>
<p>The same colouring techniques used above (using a <code>group</code>
aesthetic, with <code>scale_colour_gradient</code>) might also be used
to illustrate the dependence of the ENBS curve on the
willingness-to-pay.</p>
<p>Uncertainty around the ENBS can be illustrated by plotting quantiles
of the ENBS alongside the point estimates. These quantiles can be
derived from the point estimate (<code>enbs</code>) and the standard
deviation (<code>sd</code>) stored in the data frame that we called
<code>nbs</code>, assuming a normal distribution.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span><span class="op">==</span><span class="fl">20000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>q975 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span>, <span class="va">enbs</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>         q75 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="va">enbs</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>         q25 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="va">enbs</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>         q025 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="va">enbs</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">enbs</span>, x<span class="op">=</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">q025</span>, ymax<span class="op">=</span><span class="va">q975</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"gray80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">q25</span>, ymax<span class="op">=</span><span class="va">q75</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Sample size"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected net benefit of sampling"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html" class="external-link">dollar_format</a></span><span class="op">(</span>prefix<span class="op">=</span><span class="st">"£"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="fl">1100</span>,y<span class="op">=</span><span class="fl">85000000</span>,label<span class="op">=</span><span class="st">"95% credible interval"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="fl">1250</span>,y<span class="op">=</span><span class="fl">70000000</span>,label<span class="op">=</span><span class="st">"50% credible interval"</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="optss">Optimal sample size<a class="anchor" aria-label="anchor" href="#optss"></a>
</h2>
<p>The <code><a href="../reference/enbs.html">enbs()</a></code> function also estimates the optimal sample
size for each willingness-to-pay value. That is, the sample size which
gives the maximum expected net benefit of sampling. The optimal sample
size can be estimated using two alternative methods.</p>
<ol style="list-style-type: decimal">
<li><p>A simple and fast method: just pick the highest ENBS from among
the sample sizes included in the <code>evsi</code> object that was
supplied to <code><a href="../reference/enbs.html">enbs()</a></code>.</p></li>
<li><p>A more sophisticated (but slower) method uses nonparametric
regression to smooth and interpolate the ENBS estimates. This is useful
if the EVSI has only been computed for a limited number of sample sizes,
or if the EVSI estimates are noisy (which may happen for the
regression-based method). We might judge that the ENBS is a smooth
function of sample size, that we could estimate by regression on the
estimates that have been computed.</p></li>
</ol>
<div class="section level3">
<h3 id="smooth-interpolation">Smooth interpolation<a class="anchor" aria-label="anchor" href="#smooth-interpolation"></a>
</h3>
<p>Here is a demonstration of how the regression smoothing method
works.</p>
<ul>
<li><p>Suppose we have computed EVSI (hence ENBS) for a limited set of
sample sizes, say eight, from 100 to 800 by 100, and for a specific
willingness to pay (and population size, horizon and discount
rate).</p></li>
<li><p>The function <code>enbs_opt</code> is used to create from this a
smoothed and interpolated dataset (here called <code>preds</code>) that
contains 701 ENBS estimates, for every integer from 100 to 800. The
maximum ENBS can then be found by searching through this interpolated
dataset.</p></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbs_subset</span> <span class="op">&lt;-</span> <span class="va">nbs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span><span class="op">==</span><span class="fl">20000</span>, <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">800</span>,by<span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">eopt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enbs_opt.html">enbs_opt</a></span><span class="op">(</span><span class="va">nbs_subset</span>, smooth<span class="op">=</span><span class="cn">TRUE</span>, keep_preds<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>enbs_opt</code> function returns the maximum ENBS
(<code>enbsmax</code>), the optimal sample size (<code>nmax</code>) and
an interval estimate (<code>nlower</code> to <code>nupper</code>)
defined by the lowest and highest sample size that have ENBS within 5%
of the optimum.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eopt</span></span></code></pre></div>
<pre><code><span><span class="co">##     ind  enbsmax nmax nlower nupper</span></span>
<span><span class="co">## 393 201 83950193  492    239    788</span></span></code></pre>
<p>The full interpolated dataset is also returned as the
<code>"preds"</code> attribute.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">eopt</span>, <span class="st">"preds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">preds</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n     enbs ind  enbsmax nmax nlower nupper</span></span>
<span><span class="co">## 1 100 63987440 201 83950193  492    239    788</span></span>
<span><span class="co">## 2 101 64128147 201 83950193  492    239    788</span></span></code></pre>
<p>In this graph, the eight pre-computed ENBS values are shown as
points, and the 701 smoothed/interpolated values are shown on a
line.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nbs_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n</span>, y<span class="op">=</span><span class="va">enbs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">preds</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Sample size"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected net benefit of sampling"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html" class="external-link">dollar_format</a></span><span class="op">(</span>prefix<span class="op">=</span><span class="st">"£"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">eopt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">nlower</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"blue"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">eopt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">nmax</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"blue"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">eopt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">nupper</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"blue"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">eopt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">enbsmax</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"blue"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>The maximum, and the range of sample sizes whose ENBS is within 5% of
this maximum, are shown as blue dotted lines.</p>
<blockquote>
<p><strong>Technical note:</strong> this uses the default spline
regression model <code>s()</code> from the <code>gam</code> function in
the <code>mgcv</code> package. The flexibility of the fitted model can
be configured by setting the <code>smooth_df</code> argument to either
<code>enbs</code> or <code>enbs_opt</code>. This is passed as the
<code>k</code> argument to the <code>s()</code> function, and defaults
to 6 (or the number of sample sizes minus 1, if this is lower than
6).</p>
</blockquote>
<p><code>enbs_opt</code> assumes a single willingness-to pay (and
population size, etc). In practice you do not need to use
<code>enbs_opt</code>, unless you want to check the goodness-of-fit of
the regression that is fitted. Instead you can just call
<code>enbs(..., smooth=TRUE)</code>, and this will determine the optimal
sample size, using smoothing, for each of multiple willingness-to-pay
values (see the <code>nbs_smoothed</code> object below for an
example).</p>
</div>
<div class="section level3">
<h3 id="note-about-uncertainty">Note about uncertainty<a class="anchor" aria-label="anchor" href="#note-about-uncertainty"></a>
</h3>
<p>In this example, there are a wide range of sample sizes within 5% of
the optimum. In practice, the cheapest study, the one at the bottom of
this range, might still be deemed acceptable to decision-makers. There
is still a lot of unacknowledged uncertainty in this analysis, including
about the costs, incident population size, decision horizon, and
computational uncertainty in the per-person EVSI estimate. The location
of the “exact” maximum of the curve of ENBS versus sample size might be
considered a minor issue in the context of these other
uncertainties.</p>
</div>
<div class="section level3">
<h3 id="curve-of-optimal-sample-size">Curve of optimal sample size<a class="anchor" aria-label="anchor" href="#curve-of-optimal-sample-size"></a>
</h3>
<p>For convenience, the <code><a href="../reference/enbs.html">enbs()</a></code> function also returns, as
the <code>"enbsmax"</code> attribute, a data frame with one row per
willingness-to-pay (<code>k</code>), giving the optimal ENBS
(<code>enbsmax</code>) the optimal sample size (<code>nmax</code>) and
an interval estimate for the optimal sample size (<code>nlower</code> to
<code>nupper</code>). An extract is shown here.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nbs</span>, <span class="st">"enbsmax"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">20000</span>,<span class="fl">50000</span>,by<span class="op">=</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ind    enbsmax nmax nlower nupper     k</span></span>
<span><span class="co">## 1 201 84091443.3  450    250    750 20000</span></span>
<span><span class="co">## 2 301 24976901.6  450    350    600 30000</span></span>
<span><span class="co">## 3 401  7291455.8  400    350    500 40000</span></span>
<span><span class="co">## 4 501   406604.1  400    400    400 50000</span></span></code></pre>
<p>This allows a plot to be drawn of the optimal sample size against
willingness to pay, with an interval estimate defined by this range of
“95% optimal” sample sizes. This is compared here for the two methods of
determing the optimum: with and without smoothing.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nbs</span>, <span class="st">"enbsmax"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">nmax</span>, x<span class="op">=</span><span class="va">k</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">nlower</span>, ymax<span class="op">=</span><span class="va">nupper</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">800</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Willingness to pay (£)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Optimal sample size"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Unsmoothed"</span><span class="op">)</span></span>
<span><span class="va">nbs_smoothed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enbs.html">enbs</a></span><span class="op">(</span><span class="va">chemo_evsi_or</span>, </span>
<span>                     costs_setup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5000000</span>, <span class="fl">10000000</span><span class="op">)</span>, </span>
<span>                     costs_pp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28000</span>, <span class="fl">42000</span><span class="op">)</span>, </span>
<span>                     pop <span class="op">=</span> <span class="fl">46000</span>, time <span class="op">=</span> <span class="fl">10</span>, smooth<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nbs_smoothed</span>, <span class="st">"enbsmax"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">nmax</span>, x<span class="op">=</span><span class="va">k</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">nlower</span>, ymax<span class="op">=</span><span class="va">nupper</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">800</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Willingness to pay (£)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Optimal sample size"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Smoothed"</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="probce">Probability of a cost-effective trial<a class="anchor" aria-label="anchor" href="#probce"></a>
</h2>
<p>Given the uncertainty about the incident population size and decision
time horizon, we might want to show how the results depend on these.
This might be done using a heat map.</p>
<p>The next plot selects a specific willingness to pay (£20,000) and
plots the probability that a study with a sample size of 400 is cost
effective, i.e. the probability that the expected net benefit of
sampling is positive. This is compared on a grid defined by a range of
population sizes from 0 to 60000, and a range of decision horizon times
from 0 to 10.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enbs.html">enbs</a></span><span class="op">(</span><span class="va">chemo_evsi_or</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">k</span><span class="op">==</span><span class="fl">20000</span>, <span class="va">n</span><span class="op">==</span><span class="fl">400</span><span class="op">)</span>, </span>
<span>            costs_setup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5000000</span>, <span class="fl">10000000</span><span class="op">)</span>, </span>
<span>            costs_pp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28000</span>, <span class="fl">42000</span><span class="op">)</span>, </span>
<span>            pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">60000</span>,length.out<span class="op">=</span><span class="fl">50</span><span class="op">)</span>, </span>
<span>            time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span>,length.out<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nbs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">pop</span>, x<span class="op">=</span><span class="va">time</span>, fill<span class="op">=</span><span class="va">pce</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"Probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low<span class="op">=</span><span class="st">"darkblue"</span>, high<span class="op">=</span><span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Decision horizon (years)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Incident population"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="plots_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
